<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<label><textarea id="log" rows="15" cols="70" disabled></textarea></label>
<br>
<button onclick="clickConnect()" id="connect">Connect</button>
<button onclick="clickLogin()" id="login" disabled>Login</button>
<button onclick="clickStartGame()" id="start" disabled>Start Game</button>
<button onclick="clickRollDice()" id="roll" disabled>Roll Dice</button>

<script>
    function buildPacket(type, data) {
        return JSON.stringify({type: type, ...data})
    }

    const con = {
        socket: undefined,
        connected: false,
    }
    let state = undefined

    const log = document.getElementById("log")
    log.value = ''
    const connect = document.getElementById("connect")
    const login = document.getElementById("login")
    const start = document.getElementById("start")
    const roll = document.getElementById("roll")

    const callbacks = {
        'ERROR': (packet) => {
            log.value += `Error: ${packet.message}\n`
        },
        'DEBUG': (packet) => {
            log.value += `Debug: ${packet.message}\n`
        },
        'LOGIN': (packet) => {
            log.value += `Logged in {admin: ${packet.admin}, UUID: ${packet.yourId}}\n`
            state = {
                yourId: packet.yourId,
                admin: packet.admin,
                active: false,
            }
            if (state.admin) {
                start.disabled = false
            }
        },
        'UPDATE_PLAYERS': (packet) => {
            log.value += `Updated players: ${JSON.stringify(packet.players)}\n`
        },
        'START_GAME': (packet) => {
            log.value += `Started game: ${JSON.stringify(packet.players)}\n`
            roll.disabled = false
        },
        'ACTIVE_PLAYER': (packet) => {
            log.value += `Active player: ${packet.id}\n`
            state.active = roll.disabled = packet.id === state.yourId
        },
        'ROLL': (packet) => {
            const pasch = packet.first === packet.second
            log.value += `Roll: ${packet.first}, ${packet.second}, pasch: ${pasch}, UUID: ${packet.id}\n`
        },
        'MOVE_PLAYER': (packet) => {
            log.value += `Moved player: ${packet.id}, ${packet.position}, ${packet.oldPosition}\n`
        },
        'FIELD_DATA': (packet) => {
            log.value += `Field data: ${JSON.stringify(packet.data)}\n`
        },
    }

    function clickConnect() {
        state = undefined
        connect.disabled = true
        login.disabled = true
        start.disabled = true
        roll.disabled = true
        con.socket = new WebSocket('ws://192.168.178.36:8080/game')
        con.socket.onopen = (event) => {
            login.disabled = false
            con.connected = true
            log.value += 'Connected\n'
        }
        con.socket.onmessage = (event) => {
            const packet = JSON.parse(event.data)
            callbacks[packet.type](packet)
        }
        con.socket.onclose = (event) => {
            connect.disabled = false
            login.disabled = true
            start.disabled = true
            roll.disabled = true
            con.socket = undefined
            con.connected = false
            log.value += 'Disconnected\n'
        }
    }

    function clickLogin() {
        login.disabled = true
        con.socket.send(buildPacket('LOGIN', {name: 'Skienex'}))
    }

    function clickStartGame() {
        start.disabled = true
        con.socket.send(buildPacket('START_GAME', {}))
    }

    function clickRollDice() {
        con.socket.send(buildPacket('ROLL_DICE', {}))
    }
</script>
</body>
</html>